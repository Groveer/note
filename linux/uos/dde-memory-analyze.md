# 记一次 dde-dock & dde-lock 的内存占用情况分析

# 使用工具及环境
1. htop 实时查看内存占用，可以使用`F3`查找二进制程序
2. 编译环境 从代码层面分析程序的内存占用情况，需要反复编译调试

## dde-dock
1. 运行一个正常编译的`dde-dock`程序，发现其内存在`100M`左右
2. 将Gui相关的对象注释掉，直接在`main`函数中注释掉`MainWinodw`对象，运行程序并使用htop发现，其内存占用在`35M`左右
3. 将`MainWinodw`只进行构造，注释掉其所有的方法调用，其内存占用在`71M`左右，其中的区别在于未加载所有插件，并且不显示`MainWindow`
4. 将`MainWindow`中的构造函数内容全部注释，发现其内存占用在`32M`左右
5. 逐步取消`MainWindow`构造中的注释，发现调用了`winId()`方法后，其内存占用再次达到`71M`左右
6. 猜测`winId()`应该是创建了一些窗口属性，再次注释掉`MainWindow`所有构造内容，然后将`MainWindow`show出来，发现内存占用还是在`71M`左右
7. 猜测是`Qt`显示窗口创建了一些窗口属性导致，为验证猜想，编写一个demo，实例化一个`QWidget`，但不show出来，此时内存占用在`28M`左右，但是一旦show出来，内存占用立即变为`67M`左右
8. 综上所述，`dde-dock`在启动时的内存占用都是比较合理的，但是有人反馈运行一段时间后，发现`dde-dock`的内存占用有明显的上升
9. 在测试机上正常运行操作系统，但未做任何窗口操作，保持`30分钟`后查看内存占用情况，发现`dde-dock`的内存占用未有明显变化
10. 再次猜测内存占用的上升可能和窗口预览相关，因为`dde-dock`除了窗口预览和程序图标，没有其他资源占用
11. 运行`dde-dock`后，打开几个程序并且显示其窗口预览，发现其内存占用从`100M`上升到`113M`左右，并且不再快速增长
12. 将代码中`showPreview()`调用部分去掉，再次运行程序，并且随即打开应用程序，发现其内存从`100M`增长到`102M`左右，并且不再增长
13. 将`12`步骤保持运行`30分钟`，发现内存一直保持在`102M`左右
14. 此次分析可以得出，dde-dock的内存占用都处于合理的情况，如想优化，可从窗口预览入手。

## dde-lock
1. 运行一个正常编译的`dde-lock`程序，发现其内存在`168M`左右
2. 结合`dde-dock`分析，其中`100M`属于正常占用，剩下`68M`需求排查
3. ‘dde-lock’中占用资源过多的地方就是背景图片了，分析代码可知，`LockFrame`继承自`FullscreenBackground`，在`FullscreenBackground`中发现`updateBackground()`方法，猜测该方法用来更新背景图片的
4. 在`updateBackground(path)`方法中，存在`updateBlurBackground(path)`的方法调用，注释`updateBlurBackground(path)`，运行程序，发现内存占用为`149M`
5. 在`updateBackground(path)`方法中，发现`m_background`的赋值操作，注释掉该操作，运行程序，发现内存占用为`100M`左右
6. 综上所述，`dde-lock`的内存占用基本上已经比较清晰了，如想优化，可以从`QPixmap`的缓存入手